<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="闭关修仙の小弟的博客">
    <meta name="keyword"  content="闭关修仙">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        14字符字符串和文本处理2 - 闭关修仙的小弟
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<link rel="stylesheet" href="/css/prism-darcula.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> Hello World </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>闭关修仙的小弟</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#获取对象的字符串表示-ToStirng"><span class="toc-text">获取对象的字符串表示 ToStirng</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#指定具体的格式和语言文化"><span class="toc-text">指定具体的格式和语言文化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#将多个对象格式化成一个字符串"><span class="toc-text">将多个对象格式化成一个字符串</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#提供定制格式化器"><span class="toc-text">提供定制格式化器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#解析字符串来获取对象-Parse"><span class="toc-text">解析字符串来获取对象 : Parse</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#编码-字符和字节的相互转换"><span class="toc-text">编码: 字符和字节的相互转换</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#字符和字节流的编码和解码"><span class="toc-text">字符和字节流的编码和解码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Base-64字符串编码和解码"><span class="toc-text">Base-64字符串编码和解码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#安全字符串"><span class="toc-text">安全字符串</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么情况下用SecureString"><span class="toc-text">什么情况下用SecureString?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Marshal类提供用于操纵安全字符串的方法"><span class="toc-text">Marshal类提供用于操纵安全字符串的方法</span></a></li></ol></li></ol>
</div>

    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> Hello World </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        14字符字符串和文本处理2
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2019-08-15 14:25:05</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#CLR读书笔记" title="CLR读书笔记">CLR读书笔记</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <h1 id="获取对象的字符串表示-ToStirng"><a href="#获取对象的字符串表示-ToStirng" class="headerlink" title="获取对象的字符串表示 ToStirng"></a>获取对象的字符串表示 ToStirng</h1><p>System.Object定义了一个pulic,virtual,无参的ToString方法.</p>
<p>System.Object的ToStirng实现的只是返回对象所属类型的全名,这对于许多不能提供有意义的字符串的类型来说,这是一个合理的默认值.</p>
<p>想要提供合理的方式获取对象当前值的字符串表示,就应重写ToString方法. 定义类时应该总是重写ToString方法,以提供良好的调试支持.</p>
<h2 id="指定具体的格式和语言文化"><a href="#指定具体的格式和语言文化" class="headerlink" title="指定具体的格式和语言文化"></a>指定具体的格式和语言文化</h2><p>无参的ToString方法有两个问题:</p>
<ul>
<li>无法控制字符串的格式</li>
<li>不能选择一种特定的语言文化来格式化字符串</li>
</ul>
<p>为了解决这个,类型应该实现<code>System.IFormattable</code>接口:</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// FCL的所有基类型都实现了这个接口, 另一些类型(Guid)也实现了它</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFormattable</span>
<span class="token punctuation">{</span>
  String <span class="token function">ToString</span><span class="token punctuation">(</span>String format<span class="token punctuation">,</span> IFormatProvider formatprovider<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>IFormattable方法获取两个参数,</p>
<ul>
<li><code>String format</code>: 告诉方法如何格式化字符串</li>
<li><code>formatprovider</code>: 是一个实现了IFormatProvider接口的实例类型,提供具体的语言文化信息.</li>
</ul>
<p>FCL中定义的许多类型都能同时识别几种格式, 例如,</p>
<ul>
<li>DateTime<ul>
<li>d 表示短日期</li>
<li>D 表示长日期</li>
<li>g 表示常规</li>
<li>M 表示月/日</li>
<li>s 表示可排序</li>
<li>T 表示长时间</li>
<li>u 表示ISO8601格式的协调世界时</li>
<li>U 表示长日期格式的协调世界时</li>
<li>Y 表示年/月</li>
</ul>
</li>
<li>所有枚举<ul>
<li>G 表示常规</li>
<li>F 表示标志</li>
<li>D 表示十进制</li>
<li>X 表示十六进制</li>
</ul>
</li>
<li>所有内建数值类型<ul>
<li>C 表示货币格式</li>
<li>D 表示十进制格式</li>
<li>E 表示科学计数法</li>
<li>F 表示定点(fix-point)格式</li>
<li>G 表示常规格式</li>
<li>N 表示数字格式</li>
<li>P 表示百分比格式</li>
<li>R 表示往返行程(round-trip)格式<ul>
<li>保证转换为字符串的数值再次被分析为相同的数值</li>
<li>此格式仅有浮点型(Single,Double)支持</li>
</ul>
</li>
<li>X 表示十六进制</li>
</ul>
</li>
<li>数值类型还支持 picture数值格式字符串###,###可以显示千分位分隔符. (详情参考自定义数字格式字符串)</li>
</ul>
<p><img src="/2019/08/15/CLR读书笔记/14字符字符串和文本处理2/R说明符.png" alt=""></p>
<p>大多数类型,调用ToStirng传递null完全等价于传递格式字符串<code>G</code>.</p>
<p>关于语言文化,默认无参ToString方法默认使用与调用线程关联的语言文化信息进行格式化.如果formatprovider传null,IFormattable的ToString也这么做.</p>
<p>格式化数组(货币,整数,浮点数,百分比,日期和时间)适合应用对语言文化敏感的信息.</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 一下代码将以越南地区适用的货币格式来获取一个Decimal数值的字符串表示.</span>
Decimal price <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">.</span>54M<span class="token punctuation">;</span>
String s <span class="token operator">=</span> price<span class="token punctuation">.</span><span class="token function">ToStirng</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">CultureInfo</span><span class="token punctuation">(</span><span class="token string">"vi-VN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2019/08/15/CLR读书笔记/14字符字符串和文本处理2/越南货币显示.png" alt=""></p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 这个版本调用ToString(null,null);</span>
<span class="token comment" spellcheck="true">// 采用常规数值格式,采用线程的语言文化信息</span>
<span class="token keyword">public</span> <span class="token keyword">override</span> String <span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 是ToString的真正实现</span>
<span class="token comment" spellcheck="true">// 采用由调用者指定的格式和语言文化信息</span>
<span class="token keyword">public</span> String <span class="token function">ToString</span><span class="token punctuation">(</span>String format<span class="token punctuation">,</span> IFormatProvider formatprovider<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 简单的调用ToString(null,formatprovider);</span>
<span class="token comment" spellcheck="true">// 实现了IConvertible的ToString方法</span>
<span class="token keyword">public</span> String <span class="token function">ToString</span><span class="token punctuation">(</span>IFormatProvider formatprovider<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="将多个对象格式化成一个字符串"><a href="#将多个对象格式化成一个字符串" class="headerlink" title="将多个对象格式化成一个字符串"></a>将多个对象格式化成一个字符串</h2><pre class="line-numbers language-csharp"><code class="language-csharp">String s <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"On {0:D}, {1} is {2:E} years old."</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"AA"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 输出: On 2019年8月15日, AA is 9.000000E+000 years old.</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>在Format中,解析字符串时, 发现可替换<code>参数0</code>应该调用它的IFormattable接口的ToString方法,并为方法传递”D”,null参数.</p>
<p>但是如果使用StringBulider而不是String来构造字符串,可以调用StringBulider的AppendFormat方法.AppendFormat原理与String的Format相似.</p>
<p>Console的Write/WriteLine要格式化符合特定语言文化的字符串必须要调用String的Format方法.</p>
<h2 id="提供定制格式化器"><a href="#提供定制格式化器" class="headerlink" title="提供定制格式化器"></a>提供定制格式化器</h2><p>可以定义一个方法,在任何对象需要格式化字符串的时候由<code>StringBuilder</code>的<code>AppendFormat</code>方法调用该方法,按照我们希望的任何方式格式化对象. (也适用于String的Format方法)</p>
<p>也就是说,<code>AppendFormat</code>不是为每个对象调用ToString方法,而是调用自定义的方法.</p>
<p>以下代码为了将所有的Int32值在HTML中加粗显示.</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">/// &lt;summary></span>
<span class="token comment" spellcheck="true">/// 格式化定制器</span>
<span class="token comment" spellcheck="true">/// 将所有的Int32值在HTML中加粗显示.用&lt;B>&lt;/B>加粗显示</span>
<span class="token comment" spellcheck="true">/// &lt;/summary></span>
<span class="token keyword">namespace</span> FormatController
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 传入定制类BoldInt32s为参数</span>
            sb<span class="token punctuation">.</span><span class="token function">AppendFormat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoldInt32s</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"{0} {1} {2:M}"</span><span class="token punctuation">,</span> <span class="token string">"AAA"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//输出 AAA &lt;b>23&lt;/b> 8月15日</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>sb<span class="token punctuation">)</span><span class="token punctuation">;</span>         
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 需要实现IFormatProvider和ICustomFormatter接口</span>
    <span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">BoldInt32s</span> <span class="token punctuation">:</span> IFormatProvider<span class="token punctuation">,</span> ICustomFormatter
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">object</span> <span class="token function">GetFormat</span><span class="token punctuation">(</span>Type formatType<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>formatType <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>ICustomFormatter<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>       
            <span class="token keyword">return</span> Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>CurrentCulture<span class="token punctuation">.</span><span class="token function">GetFormat</span><span class="token punctuation">(</span>formatType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>       
        <span class="token keyword">public</span> <span class="token keyword">string</span> <span class="token function">Format</span><span class="token punctuation">(</span><span class="token keyword">string</span> format<span class="token punctuation">,</span> <span class="token keyword">object</span> arg<span class="token punctuation">,</span> IFormatProvider formatProvider<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">string</span> s<span class="token punctuation">;</span>       
            IFormattable formattable <span class="token operator">=</span> arg <span class="token keyword">as</span> IFormattable<span class="token punctuation">;</span>         
            <span class="token keyword">if</span><span class="token punctuation">(</span>formattable <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                s <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                s <span class="token operator">=</span> formattable<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> formatProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>         
            <span class="token keyword">if</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>Int32<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">"&lt;b>"</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">"&lt;/b>"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>       
            <span class="token keyword">return</span> s<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>     
    <span class="token punctuation">}</span>         
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>AppendFormat的工作方式:</p>
<ol>
<li>需要格式化一个可替换参数时,会调用ICustomFormatter的Format方法</li>
<li>如果不支持就调用简单的无参的ToString方法</li>
<li>如果对象支持IFormattable就调用支持富格式化的ToString,向它传递字符串和格式提供器.</li>
<li>最后核实类型是否是需求的类型,处理自定义操作.</li>
</ol>
<h1 id="解析字符串来获取对象-Parse"><a href="#解析字符串来获取对象-Parse" class="headerlink" title="解析字符串来获取对象 : Parse"></a>解析字符串来获取对象 : Parse</h1><p>从某种意义上来说,Parse扮演了一个工厂的角色. 能解析字符串的任何类型都提供了<code>公共静态方法Parse</code>.</p>
<p>以Int32类型的Parse方法为例(其他数值类型的Parse方法与此相似):</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">
<span class="token keyword">public</span> <span class="token keyword">static</span> Int32 <span class="token function">Parse</span><span class="token punctuation">(</span>String s<span class="token punctuation">,</span>NumberStyles style<span class="token punctuation">,</span> IFormatProvider provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li><code>NumberStyles</code> 参数是标志集合,标识了Parse应在字符串查找的字符,也就是s中允许的样式,不允许的会抛出异常.(也就是说 string中不能出现不对应类型的字符)</li>
<li><code>IFormatProvider</code> 获取语言文化特有的信息<br>```csharp<br>// 会抛出FormatException<br>// 字符串包含了前导空白符<br>// Int32 x = Int32.Parse(“ 123”,NumberStyles.None, null);</li>
</ul>
<p>// 这样修改,能跳过前导空白符<br>Int32 x = Int32.Parse(“ 123”,NumberStyles.AllowLeadingWhite, null);</p>
<p>// 解析16进制数<br>Int32 x = Int32.Parse(“1A”,NumberStyles.HexNumber, null); // x : 26</p>
<p>// 上述方法需要传递3个参数,为了简化编程,还提供了Parse方法的4个重载版本.</p>
<pre><code>
[数字NumberStyles的详细文档.](https://docs.microsoft.com/zh-cn/dotnet/api/system.globalization.numberstyles?redirectedfrom=MSDN&amp;view=netframework-4.8)

[日期的DateTimeStyles的详细文档](https://docs.microsoft.com/zh-cn/dotnet/api/system.globalization.datetimestyles?redirectedfrom=MSDN&amp;view=netframework-4.8)

对日期和事件的解析比较复杂, DateTime类型的Parse方法过于宽松,还提供`ParseExact`方法,接收一个picture参数,能准确描述应该如何格式化日期/时间字符串,以及如何解析.

[参考DateTimeFormatInfo的详细文档](https://docs.microsoft.com/zh-cn/dotnet/api/system.globalization.datetimeformatinfo.-ctor?redirectedfrom=MSDN&amp;view=netframework-4.7.2)

## 关于Parse性能上的问题

如果应用程序频繁调用Parse,而且Parse频繁抛出异常(用户无效输入),应用程序性能会显著下降.

为此, Microsoft为所有的`数值数据类型`,`DateTime类型`,`TimeSpan类型`,`IPAddress类型`中加入`TryParse`方法.

```csharp
// 方法返回bool, 指出传递的字符串是否能解析成功,以传引用的方式传给result
public static bool TryParse(string s,NumberStyles style,IFormatProvider provider,
  out int result);
</code></pre><h1 id="编码-字符和字节的相互转换"><a href="#编码-字符和字节的相互转换" class="headerlink" title="编码: 字符和字节的相互转换"></a>编码: 字符和字节的相互转换</h1><p>用<code>System.IO.BinaryWriter</code>或者<code>System.IO.StreamWriter</code>类型将字符串发送给文件或网络流时，通常要进行编码。对应地，<code>System.IO.BinaryReader</code>或者<code>System.IO.StreamReader</code>类型从文件或网络流中读取字符串时，通常要进行解码。不显式指定一种编码方案，所有这些类型都默认使用UTF-8。</p>
<p>FCL提供了一些类型来简化字符编码和解码. 两种最常用的编码方案是UTF-16和UTF-8.</p>
<ul>
<li><p><code>UTF-16</code>: 将每个16位字符编码成2个字节。不会对字符产生任何影响，也不发生压缩—性能非常出色。UTF-16编码也称为Unicode编码。(可以从<code>低位优先</code>转换成<code>高位优先</code>,或者<code>高位优先</code>转换成<code>低位优先</code>)</p>
</li>
<li><p><code>UTF-8</code>: 将部分字符编码成1个字节，部分编码成2个字节，部分编码成3个字节或4个字节。值在0x0080之下的字符压缩成1个字节，适合表示美国使用字符。0x00800~0x07FF的字符转换成2个字节，适合欧洲和中东语言。0x0800以及之上的字符转换成3个字节，适合东亚语言。最后代理项对表示成4个字节。0x0080编码方法非常流行，但如果要编码的许多字符都具有0x0800或者之上的值，效率不如UTF-16</p>
</li>
<li><p><code>ASCII</code>: 编码方案将16位字符编码从ASCII字符：也就是说，值小于0x0080的16位字符被转换成单字节。值超过0x007F的任何字符都不能被转换，否则字符的值会丢失。</p>
</li>
</ul>
<blockquote>
<p>应该总是选择UTF-16 UTF-8编码</p>
</blockquote>
<pre class="line-numbers language-csharp"><code class="language-csharp">String s <span class="token operator">=</span> <span class="token string">"Hi there."</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 它知道怎么使用UTF-8来进行编码和解码</span>
Encoding encodingUTF8 <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 将字符串编码成字节数组</span>
Byte<span class="token punctuation">[</span><span class="token punctuation">]</span> encodingBytes <span class="token operator">=</span> encodingUTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 显式编译好的字节值</span>
<span class="token comment" spellcheck="true">// 输出:48-69-20-74-68-65-72-65-2E</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span>encodingBytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 将字节数组解码回字符串</span>
String decodeString <span class="token operator">=</span> encodingUTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>encodingBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 显式解码的字符串</span>
<span class="token comment" spellcheck="true">// 输出: Hi there.</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>decodeString<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>不建议使用Encoding类的静态属性Defult,它返回的是对象使用用户当前的代码页来进行编码和解码(在用户控制面板的区域和语言选项中指定),也就有是说应用程序的行为会随着机器的设置而变.</strong></p>
<p><strong><code>UnicodeEncoding</code></strong>,<strong><code>UTF8Encoding</code></strong>,<strong><code>UTF32Encoding</code></strong>,<code>UTF7Encoding</code>提供了多个构造器, 允许对编码和前导码进行更多的控制. 前3个类还提供了特殊的构造器,允许在对一个无效的字节序列进行解码时抛出异常,<strong>应该使用这些能抛出异常的类.</strong></p>
<p>前导码: 也称<code>字节顺序标记</code>(BOM,Byte Order Mark).</p>
<p><img src="/2019/08/15/CLR读书笔记/14字符字符串和文本处理2/Encoding的派生类常用的方法.png" alt=""></p>
<h2 id="字符和字节流的编码和解码"><a href="#字符和字节流的编码和解码" class="headerlink" title="字符和字节流的编码和解码"></a>字符和字节流的编码和解码</h2><p>字节流通常以数据块data chunk的形式传输, 可能先从流中读5个字节,然后再7个字节,因为UTF-16每个字符都是2个字节,那么调用Encoding的GetString方法传递一个5字节的数组返回的字符串只包含2个字符,后面的7个字节返回3个,显然会造成数据损坏.</p>
<p>字节块解码首先要获取一个Encoding对象,在调用其<code>GetDecoder</code>方法.</p>
<ul>
<li>返回一个新构造对象的引用,从抽象类<code>System.Text.Decoder</code>派生.</li>
<li>Decoder提供了2个重要方法<ul>
<li>GetChars和GetCharCount.</li>
<li>它会尽可能多的解码字节数组. 如果剩余一个字节,</li>
<li><strong>则会保存到Decoder对象内部,下次调用时取出,和新的字节数组合并.</strong></li>
<li>这样就能正确解码.</li>
</ul>
</li>
</ul>
<blockquote>
<p>从流中读取字节时,Decoder对象的作用很大.</p>
</blockquote>
<p>每次调用从Encoder派生的对象都会维护余下数据的状态信息,以便成块的方式对数据进行编码.</p>
<h2 id="Base-64字符串编码和解码"><a href="#Base-64字符串编码和解码" class="headerlink" title="Base-64字符串编码和解码"></a>Base-64字符串编码和解码</h2><p>除了UTF-16和UTF-8,另一个流行方案是将<code>字节序列</code>编码成<code>Base-64字符串</code>.</p>
<p>例外的是,Base-64编码和解码不是用Encoding派生类型来完成,而是用<code>Convert</code>的<code>静态方法ToBase64String或ToBase64CharArray方法</code>.</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 获取10个随机生成的字节</span>
Byte<span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Byte</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NextBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 将字节解码成Base-64字节串,并显示字符串</span>
String s <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 输出: usLVdVlIgAgfsw==</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 将Base-64字符串编码回字节,并显示</span>
bytes <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">FromBase64String</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 错误用法, 显示的是类名 System.Byte[]</span>
<span class="token comment" spellcheck="true">// Console.WriteLine(bytes.ToString());</span>
<span class="token comment" spellcheck="true">// 输出: BA-C2-D5-75-59-48-80-08-1F-B3</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="安全字符串"><a href="#安全字符串" class="headerlink" title="安全字符串"></a>安全字符串</h1><p>String对象可能包含敏感数据,比如信用卡资料,密码. String对象会在内存中包含一个字符数组. 执行不安全代码或者非托管代码就可以扫描进程的地址空间,找到包含敏感数据的字符串.</p>
<p>即使String对象只用一小段时间就进行垃圾回收, CLR也可能无法立即重用String对象的内存, 致使String的字符长时间保留在进程的内存中. 由于字符串不可变,处理它们的时候,旧的副本会逗留在内存中,最终造成多个不同版本的字符串散布在整个内存空间中.</p>
<p>FCL增加了一个更安全的字符串类:<code>System.Security.SecureString</code></p>
<p>构造<code>SecureString</code>对象时,会在内部分配一个非托管内存块,其中包含一个字符数组.</p>
<ul>
<li>使用非托管内存块是为了避开垃圾回收器的魔爪.</li>
<li>这些字符串是经过加密的,能防范任何恶意的非安全/非托管代码获取机密信息.</li>
</ul>
<p><code>SecureString</code>类的操作方法:</p>
<ol>
<li><code>AppendChar</code> 附加</li>
<li><code>InsertAt</code> 插入</li>
<li><code>RemoveAt</code> 删除</li>
<li><code>SetAt</code> 设置一个字符</li>
</ol>
<p>但是调用这些方法时,方法内部会进行 <strong>解密</strong> ,执行完指定的操作再 <strong>重新加密</strong> 字符串.<strong>这说明有一段时间是处于未加密的状态.</strong> 并且这些操作性能会比较一般.</p>
<p><code>SecureString</code>类实现了<code>IDisposable</code>接口. 用简单的方式 <strong>确定性</strong> 地摧毁字符串中的安全内容. 只需要调用<code>SecureString</code>的<code>Dispose</code>方法. 在方法内部,Dispose会对内存缓冲区的内容进行清零.然后释放缓冲区.</p>
<p>SecureString对象内部有一个SafeBuffer派生的对象负责维护字符串,SafeBuffer类最终从CriticalFinalizerObject类派生,所以在垃圾回收时,内容保证清零,缓冲区被释放.</p>
<p><code>SecureString</code>对象被垃圾回收后,加密的字符串的内容将不再存于内存中.</p>
<p>FCL限制了对<code>SecureString类</code>的支持. 只有少数方法才能接受<code>SecureString参数</code>.</p>
<p>要使用的话可以创建自己的方法来接收SecureString对象参数,方法内部必须先让SecureString对象创建一个非托管内存缓冲区,它将用于包含解密过的字符,然后才能让该方法使用缓冲区.为了最大程度降低恶意代码获取敏感数据的风险,你的代码在访问解密过的字符串时,时间应尽可能短,结束使用后,代码尽快清零并释放缓冲区. <strong>不要将SecureString内容放到一个String中. String会在堆中保持未加密的状态.</strong> 并且SecureString没有重写ToString方法,就是为了避免这个.</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// using代码块之后,SecureString被dispose,内存中无敏感数据</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span>SecureString ss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"请输入密码:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 参数true意思是,拦截输入,不显示在控制台上</span>
            ConsoleKeyInfo cki <span class="token operator">=</span> Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 回车表示输入完成</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cki<span class="token punctuation">.</span>Key <span class="token operator">==</span> ConsoleKey<span class="token punctuation">.</span>Enter<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 将密码附加到SecureString中</span>
            ss<span class="token punctuation">.</span><span class="token function">AppendChar</span><span class="token punctuation">(</span>cki<span class="token punctuation">.</span>KeyChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 密码已经输入,出于演示的目的显示它</span>
        <span class="token function">DisplaySecureString</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 这个代码是unsafe,要访问非托管内存</span>
<span class="token keyword">private</span> <span class="token keyword">unsafe</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">DisplaySecureString</span><span class="token punctuation">(</span>SecureString ss<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Char<span class="token operator">*</span> pc <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 将SecureString解密到一个非托管内存缓冲区</span>
        pc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> Marshal<span class="token punctuation">.</span><span class="token function">SecureStringToCoTaskMemUnicode</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 访问包含已经解密SecureString字符的非托管内存缓冲区</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> pc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>pc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 确定清零并释放包含已解锁SecureString字符的非托管内存缓冲区</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pc <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Marshal<span class="token punctuation">.</span><span class="token function">ZeroFreeCoTaskMemUnicode</span><span class="token punctuation">(</span><span class="token punctuation">(</span>IntPtr<span class="token punctuation">)</span> pc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="什么情况下用SecureString"><a href="#什么情况下用SecureString" class="headerlink" title="什么情况下用SecureString?"></a>什么情况下用SecureString?</h3><p>如果以下情况下，<code>SecureString</code>非常有用：</p>
<ul>
<li>您可以逐字符构建它(例如从控制台输入)，或者从非托管API获得它。</li>
<li>您可以通过将它传递给非托管API(SecureStringToBSTR)来使用它。<br><strong>如果您曾经将其转换为托管字符串，则您已经放弃了它的用途。</strong></li>
</ul>
<p>我会看到的主要用例是在客户端应用程序中，它要求用户输入高度敏感的代码或密码。用户输入可以逐字符用于构建SecureString，然后将其传递给非托管API，该API对它使用后接收的BSTR进行零。任何后续内存转储都不会包含敏感字符串。<br>在服务器应用程序中，很难看出它在哪里有用。</p>
<h2 id="Marshal类提供用于操纵安全字符串的方法"><a href="#Marshal类提供用于操纵安全字符串的方法" class="headerlink" title="Marshal类提供用于操纵安全字符串的方法"></a>Marshal类提供用于操纵安全字符串的方法</h2><p><code>System.Runtime.InteropServices.Marshal类</code>提供5个方法来将一个<code>SecureString</code>的字符 <strong>解密到非托管</strong> 内存缓冲区. 所有方法都是静态方法.所有方法都接受一个SecureString参数,并返回IntPtr.</p>
<p>每个方法都有一个配对方法来清零并释放内部缓冲区.</p>
<p><img src="/2019/08/15/CLR读书笔记/14字符字符串和文本处理2/Marshal提供操作安全字符串的方法.png" alt=""></p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/img/donate.jpg">
        <p> 感谢支持 </p>
    </div>
</div>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/zxt385189207">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://www.baidu.com">baidu</a></span>
        <span>/</span>
        
        <span><a href="https://www.google.com">google</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script type="text/javascript">
       (function() {
           if (typeof LivereTower === 'function') { return; }

           var j, d = document.getElementById('lv-container');

           d.setAttribute('data-id','city');
           d.setAttribute('data-uid' , 'MTAyMC80NTEwMS8yMTYxOA==');

           j = document.createElement('script');
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           d.appendChild(j);
       })();
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    </div>

</html>
