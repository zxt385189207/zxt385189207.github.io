<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="闭关修仙の小弟的博客">
    <meta name="keyword"  content="闭关修仙">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        7常量和字段 - 闭关修仙的小弟
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<link rel="stylesheet" href="/css/prism-darcula.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> Hello World </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>闭关修仙的小弟</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#常量"><span class="toc-text">常量</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#常量是怎么保存的"><span class="toc-text">常量是怎么保存的?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常量的跨程序集问题"><span class="toc-text">常量的跨程序集问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#字段"><span class="toc-text">字段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#如何定义一个与类型本身关联的字段"><span class="toc-text">如何定义一个与类型本身关联的字段</span></a></li></ol></li></ol>
</div>

    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> Hello World </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        7常量和字段
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2019-07-27 15:41:44</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#CLR读书笔记" title="CLR读书笔记">CLR读书笔记</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <h1 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h1><p><code>常量</code>是从不变化的符号. 它的值必须能在编译时确定. 编译器将常量值保存到程序集的元数据中. 这意味着只能定义编译器识别的基元类型常量.</p>
<ul>
<li>Boolean</li>
<li>Char</li>
<li>Byte</li>
<li>SByte</li>
<li>Int16</li>
<li>UInt16</li>
<li>Int32</li>
<li>UInt32</li>
<li>Int64</li>
<li>UInt64</li>
<li>Single (float)</li>
<li>Double</li>
<li>Decimal</li>
<li>String</li>
</ul>
<p>特殊的是: C#允许定义非基元类型的常量变量,但是必须为null;</p>
<p><code>public const SomeType Empty = null;</code></p>
<p>定义常量将导致创建元数据,总是被视为静态成员,而不是实例成员.</p>
<blockquote>
<p> C#不允许为常量指定static关键字,因为常量是总是隐式的static.</p>
</blockquote>
<h2 id="常量是怎么保存的"><a href="#常量是怎么保存的" class="headerlink" title="常量是怎么保存的?"></a>常量是怎么保存的?</h2><ol>
<li>代码引用常量符号时, 编译器在定义常量的程序集的元数据中查找符号,提取常量的值,将值嵌入生成的IL代码中.</li>
<li>由于常量的值直接嵌入代码,所以运行时不需要为常量分配任何内存.</li>
<li>不能获取常量的地址,也不能以传引用的方式传递常量</li>
<li>不能很好的支持跨程序集的版本控制</li>
</ol>
<h2 id="常量的跨程序集问题"><a href="#常量的跨程序集问题" class="headerlink" title="常量的跨程序集问题"></a>常量的跨程序集问题</h2><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 程序集A 类TypeA</span>
<span class="token keyword">public</span> <span class="token keyword">const</span> A <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 程序集B,引用了程序集A</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>TypeA<span class="token punctuation">.</span>A<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>程序集B生成应用程序B之后, 用IL代码看出, <strong>常量值直接嵌入IL代码</strong>.</p>
<p>如果程序集A,开发人员改变常量值为1000,只重新生成程序集A,应用程序B不会被影响,常量值还是50. 只有重新编译程序集B并生成才可以.</p>
<p>如果希望在运行时从一个程序集中提取另一个程序集的值,不应该使用常量,而应该使用<code>readonly</code>字段.</p>
<h1 id="字段"><a href="#字段" class="headerlink" title="字段"></a>字段</h1><p><code>字段</code>是一种数据成员,其中容纳了一个值类型的实例或者对一个引用类型的引用.</p>
<p><img src="/2019/07/27/000000目录-CLR读书笔记/7常量和字段/字段修饰符.png" alt=""></p>
<blockquote>
<p>volatile 翻译为可变的, 其实它是短暂存在,易变的意思,因为可能有多个线程都想对这个字段进行修改. “易变/易失” 翻译更佳.</p>
</blockquote>
<p>CLR支持</p>
<ul>
<li>类型字段.(<strong>静态</strong>)<ul>
<li>容纳字段数据所需的动态内存是在<code>类型对象</code>中创建时分配的. <code>类型对象</code>是在类型加载到<code>AppDomain</code>时创建的.</li>
</ul>
</li>
</ul>
<blockquote>
<p>类型对象通常是在引用了 <strong>该类型的任何方法首次进行JIT编译</strong> 的时候,将该类型加载到AppDomain中.</p>
</blockquote>
<ul>
<li>实例字段.(<strong>非静态</strong>)<ul>
<li>容纳字段数据所需的动态内存是在 <strong>构造类型的实例时分配</strong> 的.</li>
</ul>
</li>
</ul>
<p>字段存储在动态内存中,它们的值在运行时才能获取.(字段还解决了常量存在版本控制问题). 此外字段可以使任何数据类型,不像常量仅仅局限于编译器内置的基元类型.</p>
<p>CLR支持<code>readonly字段</code>和<code>read/write字段</code>.</p>
<ul>
<li><code>readonly字段</code><ul>
<li>只能在构造器方法中写入.(构造器方法只调用一次,即对象首次创建的时.)</li>
<li>编译器和验证机制确保readonly字段不会被构造器以外的任何方法写入.</li>
<li><strong>可以利用反射来修改readonly字段(非常规手段反射,操作内存)</strong>.</li>
</ul>
</li>
</ul>
<p>更改上一段代码,程序集B的代码不需要改,这样如果修改程序集A的值为1000,程序集B不需要重新编译就能获取到新值.</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 程序集A 类TypeA</span>
<span class="token comment" spellcheck="true">// 字段和类型关联需要用static关键字</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> A <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>当某个字段是引用类型,并且该字段被标记为readonly时,<code>不可变的是引用</code>,而不是<code>字段引用的对象</code>.</strong></p>
<pre class="line-numbers language-csharp"><code class="language-csharp">
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> Char<span class="token punctuation">[</span><span class="token punctuation">]</span> cc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Char</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true">// 合法的,可以通过编译</span>
cc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'A'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 非法的,无法通过编译,因为不能让cc引用别的东西</span>
cc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Char</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">'x'</span><span class="token punctuation">,</span><span class="token string">'y'</span><span class="token punctuation">,</span><span class="token string">'z'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="如何定义一个与类型本身关联的字段"><a href="#如何定义一个与类型本身关联的字段" class="headerlink" title="如何定义一个与类型本身关联的字段"></a>如何定义一个与类型本身关联的字段</h2><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 这是一个静态的readonly字段; 在运行时对它初始化</span>
<span class="token comment" spellcheck="true">// 它的值会被计算并存储到内存中</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> Random s_random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 静态的可读可写字段</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> Int32 s_numberOfWrites <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 实例只读的字段</span>
<span class="token keyword">public</span> <span class="token keyword">readonly</span> String Pathname <span class="token operator">=</span> <span class="token string">"Untitled"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 实例可读可写的字段</span>
<span class="token keyword">private</span> System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>FileStream m_fs<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token function">SomeType</span><span class="token punctuation">(</span>String pathname<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 修改只读字段Pathname</span>
    <span class="token comment" spellcheck="true">// 在构造器中可以这样做</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>Pathname <span class="token operator">=</span> pathname<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述代码许多字段都是<code>内联初始化</code>的. C#允许使用这种内联初始化语法来初始化类的<code>常量</code>,<code>可读可写字段</code>和<code>readonly字段</code>.</p>
<p>c#其实是在构造器对字段进行初始化的, 字段的内联初始化只是一种语法上的简化.(有些情况用内联语法需要考虑性能问题)</p>
<blockquote>
<p>内联初始化: 代码中直接赋值来初始化,而不是将对构造器的调用写出来.</p>
</blockquote>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/img/donate.jpg">
        <p> 感谢支持 </p>
    </div>
</div>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/zxt385189207">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://www.baidu.com">baidu</a></span>
        <span>/</span>
        
        <span><a href="https://www.google.com">google</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script type="text/javascript">
       (function() {
           if (typeof LivereTower === 'function') { return; }

           var j, d = document.getElementById('lv-container');

           d.setAttribute('data-id','city');
           d.setAttribute('data-uid' , 'MTAyMC80NTEwMS8yMTYxOA==');

           j = document.createElement('script');
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           d.appendChild(j);
       })();
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    </div>

</html>
